# 時系列オッズ取得アプリ（v0.8）要件定義書

## 1. 概要
本システムは、JRA-VAN Data Lab.のAPI（JV-Link）を利用し、過去の「時系列オッズ（単勝・複勝）」を効率的かつ安定して取得・保存するためのアプリケーションである。
特に、大量の過去データを取得する際の「通信エラー」「アプリの強制終了」「データの欠損」に対する堅牢なリカバリ機能を特徴とする。

## 2. システム構成
- **言語**: Python 3.11+
- **外部IF**: JRA-VAN JV-Link (COM Object)
- **DB**: SQLite 3
- **動作環境**: Windows 10/11 (JV-Link動作環境に準拠)

## 3. 機能要件

### 3.1 データ取得機能
1.  **時系列オッズ取得（0B41）**
    - ユーザーが指定した期間（開始日～終了日）に含まれる全レースの時系列オッズを取得する。
    - **2段階取得プロセス**:
        1.  まず期間内の「レース開催情報（RACE）」を一括スキャンし、有効なレースキーリストを作成する。
        2.  作成したリストに基づき、1レースずつ詳細な時系列データを取得する。
    - **取得対象データ**:
        - レース基本情報（RAレコード）
        - 単勝オッズ時系列（O1レコード）
        - 複勝オッズ時系列（O2レコード）※提供されている場合

### 3.2 安定化・リカバリ機能（重点項目）
1.  **リトライ処理**
    - 通信エラーや一時的な失敗が発生した場合、最大3回までリトライを行う。
    - 3回失敗した場合、自動的に「あきらめて次のレースへ進む」か「完全にスキップする」か判定を行う。

2.  **ハードリセット（強力な復旧）**
    - リトライ時には、単に再要求するだけでなく、**JV-Link接続を一度切断し、オブジェクトを破棄（GC）してから再接続**する。
    - これにより、ドライバ内部で発生した「固まり」や「ゾンビ状態」を解消する。

3.  **途中再開（レジューム）機能**
    - 取得に成功したレースIDを `data/completed_races.log` に即座に記録する。
    - アプリ再起動時にはこのログを参照し、**既に取得済みのレースは自動的にスキップ**する。
    - これにより、数万レースの処理中にPCが落ちても、直近の箇所から即座に再開可能とする。

4.  **クラッシュ検知・自動回避機能**
    - レース処理開始時に「処理中マーク」をファイルに書き込む。
    - もしアプリが強制終了した場合、次回の起動時に「前回落ちたレース」を特定できる。
    - **「前回落ちたレース」は危険なデータとみなし、自動的にスキップリストに登録**して処理を継続する。これによる無限クラッシュループを防ぐ。

5.  **欠損データの高速スキップ**
    - JRA-VANサーバー側から「データなし（Code -203, -111, -1）」が返された場合、リトライを行わずに**即座にスキップ**する。
    - これにより、中止レースやデータ不備のある期間での無駄な待機時間を削減する。

### 3.3 データ保存機能
1.  **SQLite保存**
    - 取得したデータをリレーショナルデータベースに格納する。
    - `races` テーブル: レース概要
    - `odds_time_series` テーブル: 時系列オッズデータ
2.  **トランザクション管理**
    - 一定件数（500件）ごと、またはレース単位の区切りでコミットを行い、処理中断時のデータロスを最小限に抑える。

## 4. 非機能要件
1.  **メモリ管理**
    - `JVGets` のバッファサイズを適切に管理（40KB～100KB）し、メモリ断片化を防ぐ。
    - 定期的なガベージコレクション（GC）を考慮した実装とする。
2.  **ログ出力**
    - 処理進捗をコンソールに表示する。
    - エラー発生時はエラーコード（Code）と例外内容（Traceback）を表示し、原因特定を容易にする。

## 5. 制約事項
- JRA-VAN JV-Linkキーがインストールされ、認証が通っていること。
- Windows OS上で実行されること（COM依存のため）。
- メンテナンス時間（例えば月曜深夜など）は取得できない場合がある。

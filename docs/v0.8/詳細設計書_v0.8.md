# 時系列オッズ取得アプリ（v0.8）詳細設計書

## 1. モジュール構成

### 1.1 ディレクトリ構造
```
project_root/
  ├── src/
  │    ├── collector.py       # [主処理] データ取得ロジックの中核
  │    ├── db.py             # データベース操作・パーサ
  │    └── init_db.py        # データベース初期化
  ├── data/
  │    ├── odds_history.db   # 保存用DB
  │    ├── completed_races.log # [Resume用] 完了済みレースIDリスト
  │    └── last_attempt.txt  # [Crash用] 直前の処理レースID（一時ファイル）
  ├── docs/                  # ドキュメント
  └── アプリ起動.bat          # 起動用ショートカット
```

## 2. クラス設計 (src/collector.py)

### 2.1 `OddsCollector` クラス
JRA-VANとの通信およびデータ取得フロー全体を管理する。

#### メソッド一覧
| メソッド名 | 機能概要 | v0.8での変更点 |
| :--- | :--- | :--- |
| `__init__` | インスタンス初期化、DB接続 | |
| `connect` | JVLink接続・初期化 | 何度でも再接続できるよう設計 |
| `process_race_with_retry` | **[重要]** 1レース分の取得・リトライ制御 | **ハードリセット、エラーコード判定、GC** を追加 |
| `_read_jvdata` | JVGetsを使用したデータ読み込みループ | **エラー時にFalseを返す**よう変更 |
| `fetch_historical_odds` | 指定期間の全レース取得（メインループ） | **Resume機能、クラッシュ検知、Auto-Skip** を実装 |

### 2.2 エラーハンドリング・フロー (詳細)

#### A. リトライとハードリセット (`process_race_with_retry`)
1レースの取得に失敗した場合、以下の手順を実行する。
1.  **Catch Exception**: エラーを捕捉。
2.  **Wait**: `time.sleep(2.0)` で待機。
3.  **Destruction**: `self.jvlink.JVClose()` → `self.jvlink = None` → `gc.collect()` でオブジェクトを完全破棄。
4.  **Re-Connection**: `self.connect()` で再接続。
5.  **Retry**: 再度 `JVRTOpen` を試みる。
    - これを最大3回繰り返す。

#### B. エラーコードによる即時スキップ
以下の戻り値がJVLinkから返った場合、リトライせずに即時 `Return False` とする。
- `-1`: 汎用エラー（サーバファイル欠損など）
- `-111`: 取得対象外
- `-203`: 該当データなし

#### C. クラッシュリカバリ (メインループ内)
1.  **開始前**: 現在のレースIDを `last_attempt.txt` に書き込む。
2.  **正常終了後**: `completed_races.log` に追記し、`last_attempt.txt` を削除。
3.  **起動時**:
    - `last_attempt.txt` が残っている場合、前回そのレースで落ちたと判断。
    - そのレースIDを `completed_races.log` に強制的に追加（スキップ扱い）。
    - ユーザーに「前回落ちたレースをスキップします」と通知。

## 3. データベース設計

### 3.1 `races` テーブル
| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| id | TEXT | レースID (YYYYMMDDJJRR) Primary Key |
| date | TEXT | 開催日 |
| course_id | TEXT | 競馬場コード |
| race_number | INTEGER | レース番号 |
| name | TEXT | レース名 |

### 3.2 `odds_time_series` テーブル
| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| id | INTEGER | Auto Increment PK |
| race_id | TEXT | レースID (FK) |
| time | TEXT | 発表時刻 |
| type | TEXT | 'TANSYO' or 'FUKUSYO' |
| umaban | INTEGER | 馬番 |
| odds | REAL | オッズ値 |

## 4. パラメータ設定 (定数)
- **バッファサイズ**: 40,000 Byte (安定性重視)
- **待機時間**:
    - レース間: 0.1秒 (サーバー負荷軽減)
    - リトライ前: 2.0秒 (接続安定待ち)
- **リトライ回数**: 3回

## 5. 運用フロー
1. `アプリ起動.bat` を実行。
2. 日付範囲（例: 20250101 - 20251231）を入力。
3. 「2: 時系列オッズ」を選択。
4. 自動的に処理が開始される。
    - **もし落ちたら**: 再度 `アプリ起動.bat` を実行し、同じ日付を入力するだけで自動復旧・再開する。
    - **中止レースがあれば**: 自動的にスキップされる。

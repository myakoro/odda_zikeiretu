# ターゲットCSVインポート機能

## 概要

ターゲット（TARGET frontier JV）からエクスポートした時系列オッズCSVファイルを、このアプリのデータベースにインポートする機能です。

**用途**: JRA-VANのJV-Link APIでは1年以上前のデータが取得できないため、ターゲットで取得した過去データをインポートすることで、長期間のオッズ分析が可能になります。

---

## ターゲットでのデータ取得方法

### 1. ターゲットで時系列オッズを取得

1. ターゲットを起動
2. 対象期間（例：2024年1月～12月）の時系列オッズデータを読み込み
3. ターゲット内部のデータベースに保存される

### 2. ターゲットからCSVエクスポート

1. ターゲットのエクスポート機能を使用
2. CSV形式で出力
3. `target系/` ディレクトリに保存

---

## CSVファイル形式

### ファイル名規則

```
JD07255101.CSV
  ^^^^^^^^^^
  └─ レースID: 2025年12月06日 中京(07) 1R
```

### データ構造

| カラム | 説明 | 例 |
|--------|------|-----|
| レースID | YYYYMMDDBBKRR形式 | `2025120607050101` |
| 区分 | 固定値 | `1` |
| 月日時分 | MMDDHHMM形式 | `12051831` = 12月05日18時31分 |
| 頭数 | 出走頭数 | `16` |
| 単勝票数 | 単勝の総投票数 | `1000` |
| 複勝票数 | 複勝の総投票数 | `500` |
| 1単～16単 | 各馬番の単勝オッズ | `12.5` |
| 1複Lo～16複Lo | 各馬番の複勝オッズ下限 | `3.2` |
| 1複Hi～16複Hi | 各馬番の複勝オッズ上限 | `5.8` |

**特徴**:
- **横持ち形式**: 1行 = 1つの時刻のスナップショット
- **時系列データ**: 発走前の数時間分のデータが数分間隔で記録
- **エンコーディング**: Shift-JIS

---

## インポート方法

### 単一ファイルをインポート

```powershell
python src/import_from_target.py target系/JD07255101.CSV
```

**出力例**:
```
============================================================
インポート開始: target系/JD07255101.CSV
============================================================
レース情報: 中京 1R (2025-12-06)
✓ インポート完了: 3,000 件のオッズレコード

============================================================
インポート完了サマリー
============================================================
処理ファイル数: 1
インポートレース数: 1
インポートオッズレコード数: 3,000
エラー数: 0
============================================================
```

### 複数ファイルを一括インポート

```powershell
# target系ディレクトリ内のすべてのCSVファイルをインポート
python src/import_from_target.py "target系/*.CSV"

# 特定の日付のファイルのみインポート
python src/import_from_target.py "target系/JD0725*.CSV"
```

---

## データベースへの保存形式

### races テーブル

インポートされたレース情報:

```sql
INSERT INTO races (race_id, date, ba_code, race_no, race_name, start_time)
VALUES ('202512060701', '2025-12-06', '07', 1, '中京 1R', '00:00')
```

### odds_history テーブル

時系列オッズデータ（馬番ごと、時刻ごと）:

```sql
INSERT INTO odds_history 
(race_id, time_stamp, umaban, odds_tan, odds_fuku_min, odds_fuku_max, popularity)
VALUES 
('202512060701', '2025-12-05 18:31', 1, 12.5, 3.2, 5.8, 0),
('202512060701', '2025-12-05 18:31', 2, 8.3, 2.1, 4.2, 0),
...
```

**注意**:
- `popularity`（人気順）は0固定（ターゲットCSVに含まれていないため）
- `start_time`は00:00固定（ターゲットCSVに含まれていないため）

---

## データ確認方法

### インポート結果を確認

```powershell
python verify_import.py
```

**出力例**:
```
============================================================
レース情報:
============================================================
  ID: 202512060701
  日付: 2025-12-06
  競馬場: 07
  レース番号: 1
  レース名: 中京 1R
  発走時刻: 00:00

============================================================
オッズレコード総数: 147,396 件
============================================================

時系列データ範囲:
  最初: 2025-12-05 18:30
  最後: 2025-12-06 16:36
  時刻ポイント数: 1135 個

============================================================
サンプルデータ（最初の時刻、馬番1-5）:
============================================================
  2025-12-05 18:31 | 馬番 1 | 単勝:  12.5 | 複勝:  3.2-  5.8
  2025-12-05 18:31 | 馬番 2 | 単勝:   8.3 | 複勝:  2.1-  4.2
  ...
```

### Webダッシュボードで確認

```powershell
# APIサーバーを起動
python src/api_server.py

# ブラウザで http://localhost:5000 にアクセス
```

---

## 技術仕様

### データ変換処理

1. **レースID変換**
   - ターゲット形式: `2025120607050101` (YYYYMMDDBBKKRR)
   - アプリ形式: `202512060701` (YYYYMMDDBBRR)

2. **タイムスタンプ変換**
   - ターゲット形式: `12051831` (MMDDHHMM)
   - アプリ形式: `2025-12-05 18:31` (YYYY-MM-DD HH:MM)

3. **オッズデータ変換**
   - 横持ち形式（1行に全馬番）→ 縦持ち形式（1行1馬番）
   - 馬番ごとにループして個別レコードとして保存

### エラーハンドリング

- ファイルが見つからない場合: エラーメッセージを表示して終了
- レースID解析失敗: 該当ファイルをスキップ
- オッズデータ異常: 該当馬番をスキップして処理継続
- 重複データ: `INSERT OR REPLACE` により上書き

---

## よくある質問

### Q1: 既存データと重複した場合はどうなりますか？

A: `INSERT OR REPLACE` を使用しているため、既存データは上書きされます。同じレースを複数回インポートしても問題ありません。

### Q2: JV-Linkで取得したデータとターゲットからインポートしたデータは共存できますか？

A: はい、同じデータベースに保存されます。レースIDが異なれば問題なく共存します。

### Q3: 大量のCSVファイルをインポートする場合の注意点は？

A: ワイルドカード（`*.CSV`）を使用して一括インポートできます。処理時間は1ファイルあたり数秒程度です。

### Q4: インポート後にデータを削除したい場合は？

A: SQLiteデータベースから直接削除できます：

```sql
-- 特定のレースを削除
DELETE FROM odds_history WHERE race_id = '202512060701';
DELETE FROM races WHERE race_id = '202512060701';

-- 特定の日付のデータを削除
DELETE FROM odds_history WHERE race_id LIKE '20251206%';
DELETE FROM races WHERE race_id LIKE '20251206%';
```

---

## トラブルシューティング

### エラー: `ModuleNotFoundError: No module named 'csv'`

→ Pythonの標準ライブラリなので、通常は発生しません。Python環境を確認してください。

### エラー: `UnicodeDecodeError`

→ CSVファイルのエンコーディングがShift-JISでない可能性があります。ターゲットのエクスポート設定を確認してください。

### データが正しくインポートされない

→ `verify_import.py` でデータを確認し、CSVファイルのフォーマットが正しいか確認してください。

---

## 関連ファイル

- **インポートスクリプト**: `src/import_from_target.py`
- **検証スクリプト**: `verify_import.py`
- **データベース**: `data/odds_history.db`
- **CSVファイル保存先**: `target系/`

---

## 更新履歴

- **2025-12-14**: 初版作成
  - ターゲットCSVインポート機能を実装
  - 単一ファイル・複数ファイル一括インポートに対応
  - データ検証スクリプトを追加

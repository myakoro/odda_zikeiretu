# 時系列オッズ取得アプリ 要件定義書 v0.82

**文書バージョン**: 0.82  
**作成日**: 2025-12-23  
**最終更新日**: 2025-12-23  
**ステータス**: 現行版  
**前バージョン**: v0.8

---

## 1. 文書管理情報

### 1.1 改訂履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|:---|:---|:---|:---|
| 0.8 | 2025-12-23 | 初版作成。現在の実装を完全にドキュメント化 | System |
| 0.82 | 2025-12-23 | 複勝オッズ取得機能を追加 | System |

### 1.2 v0.8からの主な変更点

#### 新機能
- **複勝オッズ取得機能の追加**: オッズ1(単複枠)レコード内の複勝オッズ部の解析機能を実装
- 単勝オッズに加えて、複勝オッズ(下限・上限)を時系列で取得・保存

#### 機能強化
- F-003: 取得対象データに複勝オッズ時系列を追加
- F-019: 複勝オッズ解析機能を新規追加

#### データベース
- 既存の `odds_fuku_min`, `odds_fuku_max` カラムに実際のデータを格納(v0.8では0.0固定)

### 1.3 文書の目的

本文書は、JRA-VAN Data Lab SDK (JV-Link) を使用した時系列オッズ取得アプリケーションの要件を定義するものである。v0.82では、v0.8の単勝オッズ取得機能に加えて、**複勝オッズ取得機能**を追加し、より包括的なオッズデータ分析を可能にする。

---

## 2. システム概要

### 2.1 システムの目的

本システムは以下の目的を達成するために開発された:

1. **過去データの効率的な取得**: JV-Link APIを使用して、指定期間のレース情報と時系列オッズデータ(単勝・複勝)を自動取得
2. **1年以上前のデータ補完**: JV-Link APIの制約(1年以内のデータのみ取得可能)を補うため、ターゲットソフトウェアからエクスポートしたCSVデータをインポート
3. **リアルタイム監視**: 開催日当日のオッズ変動(単勝・複勝)をリアルタイムで監視・記録
4. **データの永続化**: SQLiteデータベースにレース情報とオッズ履歴(単勝・複勝)を保存
5. **データ分析支援**: Webダッシュボードによるデータ可視化とCSVエクスポート機能

### 2.2 システム構成

#### 2.2.1 技術スタック

| 項目 | 技術 | バージョン | 備考 |
|:---|:---|:---|:---|
| プログラミング言語 | Python | 3.8以上 (32bit版) | **JV-Link ActiveXは32bit専用のため必須** |
| 外部API | JRA-VAN JV-Link | Ver 4.9.0.2 | COM Object (ActiveX) |
| データベース | SQLite | 3.x | ローカルファイルベース |
| Webフレームワーク | Flask | 最新 | RESTful APIサーバー |
| フロントエンド | HTML/CSS/JavaScript | - | モダンUI、Chart.js使用 |
| 動作環境 | Windows | 10/11 | JV-Link動作環境に準拠 |

#### 2.2.2 主要ライブラリ

- `pywin32`: Windows COM Object操作
- `pandas`: データ処理
- `flask`: Webサーバー
- `flask-cors`: CORS対応
- `python-dotenv`: 環境変数管理

### 2.3 システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                     ユーザーインターフェース                    │
├─────────────────────────────────────────────────────────────┤
│  Webダッシュボード (HTML/CSS/JS)  │  バッチスクリプト (.bat)  │
└──────────────┬──────────────────────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────────────────────┐
│                      アプリケーション層                         │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ collector.py │  │ realtime_    │  │ import_from_ │     │
│  │              │  │ monitor.py   │  │ target.py    │     │
│  │ (過去データ)  │  │ (リアルタイム)│  │ (CSV取込)    │     │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘     │
│         │                 │                 │              │
│         └─────────────────┼─────────────────┘              │
│                           ▼                                │
│                  ┌──────────────┐                          │
│                  │  parser.py   │                          │
│                  │ (JV-Data解析)│                          │
│                  │ ★O1+O2対応   │  ← v0.82で強化          │
│                  └──────┬───────┘                          │
│                         │                                  │
│                  ┌──────────────┐                          │
│                  │ api_server.py│                          │
│                  │ (REST API)   │                          │
│                  └──────┬───────┘                          │
└─────────────────────────┼────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                       データ層                                │
├─────────────────────────────────────────────────────────────┤
│  SQLite Database (odds_history.db)                          │
│  ├─ races テーブル (レース基本情報)                           │
│  └─ odds_history テーブル (単勝・複勝オッズ時系列)  ← v0.82で活用│
└─────────────────────────────────────────────────────────────┘
                          ▲
                          │
┌─────────────────────────┼────────────────────────────────────┐
│                    外部システム                                │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐        ┌──────────────────┐          │
│  │  JRA-VAN JV-Link │        │  ターゲット       │          │
│  │  (COM Object)    │        │  (CSVエクスポート)│          │
│  │  ★O1+O2取得      │        │                  │          │
│  └──────────────────┘        └──────────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 機能要件

### 3.1 過去データ取得機能 (collector.py)

#### 3.1.1 概要

JV-Link APIを使用して、指定期間内の全レースの時系列オッズデータ(単勝・複勝)を取得する。

#### 3.1.2 詳細機能

##### F-001: 期間指定データ取得

| 項目 | 内容 |
|:---|:---|
| 機能ID | F-001 |
| 機能名 | 期間指定データ取得 |
| 説明 | ユーザーが指定した開始日～終了日の範囲内で、全レースの時系列オッズ(単勝・複勝)を取得する |
| 入力 | 開始日(YYYYMMDD), 終了日(YYYYMMDD), データ種別("RACE"または"0B41") |
| 出力 | データベースへの保存、処理ログのコンソール出力 |
| 処理フロー | 1. レース開催情報をスキャン<br>2. 有効なレースキーリストを作成<br>3. 各レースの詳細データを取得<br>4. データベースに保存 |
| **v0.82変更点** | **複勝オッズ部の解析を追加** |

##### F-002: 2段階取得プロセス

1. **第1段階: レーススキャン**
   - データ種別 "RACE" でJVOpenを実行
   - 期間内の全レース情報を取得
   - レースキー(race_id)のリストを作成

2. **第2段階: 詳細データ取得**
   - データ種別 "0B41" (時系列オッズ) でJVRTOpenを実行
   - 各レースキーに対して個別に時系列データを取得
   - RAレコード(レース詳細)、**オッズ1レコード(単勝・複勝オッズ)** を解析 ← **v0.82で複勝部も解析**

##### F-003: 取得対象データ

| データ種別 | JV-Dataレコード | 内容 | v0.82変更 |
|:---|:---|:---|:---|
| レース基本情報 | RAレコード | レースID、開催日、競馬場コード、レース番号、レース名、発走時刻 | - |
| 単勝オッズ時系列 | O1レコード | 発表時刻、馬番、単勝オッズ、人気順 | - |
| **複勝オッズ時系列** | **オッズ1レコード(複勝部)** | **発表時刻、馬番、複勝オッズ下限・上限** | **★新規追加** |

#### 3.1.3 安定化・リカバリ機能

##### F-004 ~ F-008

(v0.8と同様のため省略)

### 3.2 ターゲットCSVインポート機能 (import_from_target.py)

(v0.8と同様のため省略)

### 3.3 リアルタイム監視機能 (realtime_monitor.py)

#### 3.3.1 概要

JV-LinkのJVRTOpen APIを使用して、開催日当日のオッズ変動(単勝・複勝)をリアルタイムで監視・記録する。

#### 3.3.2 詳細機能

##### F-013: リアルタイムデータ監視

| 項目 | 内容 |
|:---|:---|
| 機能ID | F-013 |
| 機能名 | リアルタイムオッズ監視 |
| 監視対象 | 当日開催レースのオッズ変動(単勝・複勝) |
| データ種別 | 0B12 (速報オッズ), 0B31 (単勝・複勝リアルタイム) |
| 更新間隔 | JV-Linkサーバーからのプッシュ通知(約1秒間隔でポーリング) |
| **v0.82変更点** | **複勝オッズ部も監視対象に追加** |

##### F-014: 対応データ種別

(v0.8と同様)

##### F-015: 監視ループ処理

1. JVGetsでデータ取得(バッファサイズ: 50,000 Byte)
2. レコードタイプ判定(先頭2文字)
3. オッズレコード(O1-O7)の場合、パーサーで解析 ← **v0.82: 複勝部も解析対象**
4. データベースにコミット
5. 1秒待機して次のデータを取得

##### F-016: 受信データのログ出力

```
[2025-12-23 15:30:45] 受信: 単勝オッズ
[2025-12-23 15:31:12] 受信: 複勝オッズ  ← v0.82で追加
[2025-12-23 15:32:03] 受信: 馬連オッズ
```

### 3.4 データ解析機能 (parser.py)

#### 3.4.1 概要

JV-Dataフォーマットのバイナリデータを解析し、構造化データとしてデータベースに保存する。

#### 3.4.2 詳細機能

##### F-017: RAレコード解析

(v0.8と同様)

##### F-018: O1レコード解析(単勝オッズ)

**解析対象データ**:
- レース識別情報: レースID
- オッズ発表時刻: 月日時分
- 馬番ごとのオッズ情報: 馬番、単勝オッズ、人気順(最大28頭)

**出力**:
- レースID、発表時刻、馬番、単勝オッズ、人気順をデータベースに保存
- 単勝オッズは10倍値として格納されているため、10で割って実際のオッズ値に変換

##### F-019: 複勝オッズ解析 ★新規追加

**解析対象データ**:
- レース識別情報: レースID
- オッズ発表時刻: 月日時分
- 馬番ごとのオッズ情報: 馬番、複勝オッズ下限、複勝オッズ上限(最大28頭)

**出力**:
- レースID、発表時刻、馬番、複勝オッズ下限、複勝オッズ上限をデータベースに保存
- 複勝オッズは10倍値として格納されているため、10で割って実際のオッズ値に変換

**データ統合**:
- 単勝部と複勝部は同一レコード(オッズ1)内に存在し、同一タイムスタンプで保存される
- 同一レースID・馬番・時刻のレコードが存在する場合はUPDATE、存在しない場合はINSERT

##### F-020: 安全な型変換

(v0.8のF-019と同様)

### 3.5 ~ 3.7 その他の機能

(v0.8と同様のため省略)

---

## 4. 非機能要件

(v0.8と同様)

---

## 5. 制約事項

(v0.8と同様)

---

## 6. ユースケース

### 6.1 過去データ一括取得

**基本フロー**:
1. `アプリ起動.bat` を実行
2. メニューから「1. 過去データを取得する」を選択
3. 開始日と終了日を入力
4. データ種別を選択(RACE または 0B41)
5. 自動的にデータ取得が開始される
6. **単勝オッズと複勝オッズの両方が取得される** ← **v0.82で変更**
7. 進捗がコンソールに表示される
8. 完了後、データベースに保存される

(その他のユースケースはv0.8と同様)

---

## 7. データフロー

### 7.1 過去データ取得フロー

```
[ユーザー入力]
    ↓
[collector.py]
    ↓ JVOpen("RACE")
[JV-Link API] → レース一覧取得
    ↓
[レースキーリスト作成]
    ↓
[各レースに対してループ]
    ↓ JVRTOpen("0B41", race_key)
[JV-Link API] → 時系列オッズ取得
    ↓ JVGets
[オッズ1レコード(単勝部・複勝部)]  ← v0.82: 複勝部も解析
    ↓
[parser.py] → データ解析
    ├→ parse_race_record() (RA)
    ├→ _parse_tansho_odds() (単勝部)  
    └→ _parse_fukusho_odds() (複勝部)  ← v0.82で新規追加
    ↓
[SQLite Database] → 保存
    ↓
[completed_races.log] → 完了記録
```

---

## 8. 用語集

| 用語 | 説明 |
|:---|:---|
| JV-Link | JRA-VAN Data Lab SDKが提供するCOM Object API |
| JVOpen | 過去データ取得用API |
| JVRTOpen | リアルタイムデータ監視用API |
| JVGets | データ読み込みAPI (速報系・蓄積系両対応) |
| JV-Data | JRA-VANが提供する競馬データフォーマット |
| RAレコード | レース詳細情報レコード |
| O1レコード | 単勝オッズレコード |
| **複勝オッズ部** | **オッズ1(単複枠)レコード内の複勝オッズ部分** ← **v0.82で追加** |
| レースキー | レースを一意に識別するID (YYYYMMDDJJRR形式) |
| ターゲット | 競馬予想ソフトウェア (株式会社ホースメンズ) |
| 時系列オッズ | 発走前の各時刻におけるオッズ変動データ |
| 確定オッズ | 発走直前の最終オッズ |
| 単勝 | 1着になる馬を当てる馬券 |
| **複勝** | **3着以内に入る馬を当てる馬券(オッズは下限・上限で提供)** ← **v0.82で追加** |

---

## 9. 参考資料

| 資料名 | 説明 |
|:---|:---|
| JV-Data仕様書 Ver4.9.0.1 | JV-Dataフォーマットの詳細仕様 |
| JV-Link SDK ドキュメント | JV-Link APIリファレンス |
| docs/JV-Link_ベストプラクティス.md | JV-Link使用時の注意点とベストプラクティス |
| docs/ターゲットCSVインポート.md | ターゲットCSVインポート機能の詳細 |

---

**文書終了**

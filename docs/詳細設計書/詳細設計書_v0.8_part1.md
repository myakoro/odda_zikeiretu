# 時系列オッズ取得アプリ 詳細設計書 v0.8 (Part 1/2)

**文書バージョン**: 0.8  
**作成日**: 2025-12-23  
**最終更新日**: 2025-12-23  
**ステータス**: 現行版

---

## 1. 文書管理情報

### 1.1 改訂履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|:---|:---|:---|:---|
| 0.8 | 2025-12-23 | 初版作成。現在の実装を完全にドキュメント化 | System |

### 1.2 関連文書

- 要件定義書 v0.8
- JV-Data仕様書 Ver4.9.0.1
- JV-Link SDK ドキュメント

---

## 2. システムアーキテクチャ

### 2.1 ディレクトリ構造

```
時系列オッズ取得アプリ/
├── src/                          # Pythonソースコード
│   ├── init_db.py               # データベース初期化
│   ├── parser.py                # JV-Dataパーサー
│   ├── collector.py             # 過去データ取得
│   ├── import_from_target.py    # ターゲットCSVインポート
│   ├── realtime_monitor.py      # リアルタイム監視
│   └── api_server.py            # Flask APIサーバー
├── web/                          # Webダッシュボード
│   ├── index.html               # メインHTML
│   ├── styles.css               # スタイルシート
│   └── app.js                   # JavaScript
├── data/                         # データ保存先
│   ├── odds_history.db          # SQLiteデータベース
│   ├── completed_races.log      # 完了済みレースログ
│   └── last_attempt.txt         # クラッシュ検知用一時ファイル
├── target系/                     # ターゲットCSVファイル保存先
├── docs/                         # ドキュメント
│   ├── 要件定義書/
│   ├── 詳細設計書/
│   ├── technical/
│   └── user/
├── sdk/                          # JV-Link SDK
│   └── JRA-VAN Data Lab. SDK Ver4.9.0.2/
├── .venv32/                      # Python 32bit仮想環境
├── .env                          # 環境変数設定
├── .gitignore                    # Git除外設定
├── README.md                     # プロジェクト概要
└── アプリ起動.bat                 # 起動用バッチファイル
```

### 2.2 モジュール依存関係

```
┌─────────────────────────────────────────────────────────┐
│                    アプリケーション層                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │ collector.py │  │ realtime_    │  │ import_from_ │ │
│  │              │  │ monitor.py   │  │ target.py    │ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘ │
│         │                 │                 │          │
│         └─────────────────┼─────────────────┘          │
│                           ▼                            │
│                  ┌──────────────┐                      │
│                  │  parser.py   │                      │
│                  │              │                      │
│                  │ - JVDataParser                      │
│                  └──────┬───────┘                      │
│                         │                              │
│                         ▼                              │
│                  ┌──────────────┐                      │
│                  │ api_server.py│                      │
│                  │              │                      │
│                  │ - Flask App  │                      │
│                  └──────┬───────┘                      │
└─────────────────────────┼──────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────┐
│                      データ層                            │
├─────────────────────────────────────────────────────────┤
│  SQLite Database (odds_history.db)                      │
│  ├─ races テーブル                                       │
│  └─ odds_history テーブル                                │
└─────────────────────────────────────────────────────────┘
```

---

## 3. データベース設計

### 3.1 ER図

```
┌─────────────────────────┐
│       races             │
├─────────────────────────┤
│ race_id (PK)      TEXT  │
│ date              TEXT  │
│ ba_code           TEXT  │
│ race_no           INT   │
│ race_name         TEXT  │
│ start_time        TEXT  │
└───────────┬─────────────┘
            │ 1
            │
            │ N
┌───────────┴─────────────┐
│    odds_history         │
├─────────────────────────┤
│ id (PK)           INT   │
│ race_id (FK)      TEXT  │
│ time_stamp        TEXT  │
│ umaban            INT   │
│ odds_tan          REAL  │
│ odds_fuku_min     REAL  │
│ odds_fuku_max     REAL  │
│ popularity        INT   │
└─────────────────────────┘
```

### 3.2 テーブル定義

#### 3.2.1 races テーブル

**目的**: レース基本情報を格納

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|:---|:---|:---|:---|:---|
| race_id | TEXT | NOT NULL | - | レースID (主キー)<br>形式: YYYYMMDDJJRR<br>例: 2025120605010101 |
| date | TEXT | NULL | - | 開催日<br>形式: YYYY-MM-DD<br>例: 2025-12-06 |
| ba_code | TEXT | NULL | - | 競馬場コード<br>例: 01=札幌, 05=東京, 06=中山 |
| race_no | INTEGER | NULL | - | レース番号<br>範囲: 1-12 |
| race_name | TEXT | NULL | - | レース名<br>例: "3歳未勝利" |
| start_time | TEXT | NULL | - | 発走時刻<br>形式: HH:MM<br>例: "10:10" |

**制約**:
- PRIMARY KEY: race_id
- UNIQUE: race_id

**インデックス**: なし(主キーで自動作成)

#### 3.2.2 odds_history テーブル

**目的**: 時系列オッズデータを格納

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|:---|:---|:---|:---|:---|
| id | INTEGER | NOT NULL | AUTO | 自動採番ID (主キー) |
| race_id | TEXT | NULL | - | レースID (外部キー) |
| time_stamp | TEXT | NULL | - | 取得時刻または発表時刻<br>形式: YYYY-MM-DD HH:MM:SS |
| umaban | INTEGER | NULL | - | 馬番<br>範囲: 1-28 |
| odds_tan | REAL | NULL | - | 単勝オッズ<br>例: 3.5 |
| odds_fuku_min | REAL | NULL | - | 複勝オッズ下限<br>例: 1.2 |
| odds_fuku_max | REAL | NULL | - | 複勝オッズ上限<br>例: 1.8 |
| popularity | INTEGER | NULL | - | 人気順<br>範囲: 1-28 |

**制約**:
- PRIMARY KEY: id
- FOREIGN KEY: race_id REFERENCES races(race_id)

**インデックス**:
```sql
CREATE INDEX idx_odds_race_time ON odds_history (race_id, time_stamp)
```

**目的**: レースIDと時刻による検索を高速化

### 3.3 データ容量見積もり

#### 3.3.1 1レースあたりのデータ量

- races テーブル: 1レコード ≈ 200 Byte
- odds_history テーブル:
  - 1頭1時刻: 1レコード ≈ 100 Byte
  - 18頭フルゲート × 100時刻 = 1,800レコード
  - 1レースあたり: 1,800 × 100 Byte = 180 KB

#### 3.3.2 年間データ量見積もり

- 年間開催レース数: 約3,600レース
- races テーブル: 3,600 × 200 Byte ≈ 0.7 MB
- odds_history テーブル: 3,600 × 180 KB ≈ 648 MB
- **合計**: 約650 MB/年

---

## 4. モジュール設計

### 4.1 init_db.py

#### 4.1.1 概要

データベースの初期化とスキーマ定義を行うモジュール。

#### 4.1.2 定数

```python
DB_PATH = 'data/odds_history.db'
```

#### 4.1.3 関数定義

##### init_db()

**目的**: データベースとテーブルを初期化

**引数**: なし

**戻り値**: なし

**処理フロー**:
1. データベースファイルの存在確認
2. 既存の場合はメッセージを表示して終了
3. 新規の場合、dataディレクトリを作成
4. SQLite接続を確立
5. racesテーブルを作成
6. odds_historyテーブルを作成
7. インデックスを作成
8. コミットして接続を閉じる

**SQL**:
```sql
CREATE TABLE IF NOT EXISTS races (
    race_id TEXT PRIMARY KEY,
    date TEXT,
    ba_code TEXT,
    race_no INTEGER,
    race_name TEXT,
    start_time TEXT
)

CREATE TABLE IF NOT EXISTS odds_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    race_id TEXT,
    time_stamp TEXT,
    umaban INTEGER,
    odds_tan REAL,
    odds_fuku_min REAL,
    odds_fuku_max REAL,
    popularity INTEGER,
    FOREIGN KEY (race_id) REFERENCES races(race_id)
)

CREATE INDEX IF NOT EXISTS idx_odds_race_time 
ON odds_history (race_id, time_stamp)
```

### 4.2 parser.py

#### 4.2.1 概要

JV-Dataフォーマットのバイナリデータを解析し、構造化データとしてデータベースに保存するモジュール。

#### 4.2.2 クラス: JVDataParser

##### コンストラクタ

```python
def __init__(self, db_path='data/odds_history.db'):
    """
    Args:
        db_path: データベースファイルパス
    """
    self.db_path = db_path
    self.conn = sqlite3.connect(db_path)
    self.cursor = self.conn.cursor()
```

##### メソッド一覧

| メソッド名 | 説明 | 引数 | 戻り値 |
|:---|:---|:---|:---|
| `_safe_float(val_str)` | 文字列を安全にfloatに変換 | val_str: str | float |
| `_safe_int(val_str)` | 文字列を安全にintに変換 | val_str: str | int |
| `parse_race_record(data)` | RAレコードをパース | data: bytes | None |
| `parse_odds_record(data, rec_type)` | オッズレコードをパース | data: bytes, rec_type: str | None |
| `_parse_tansho_fukusho_odds(data)` | O1レコードをパース | data: bytes | None |
| `commit()` | 変更をコミット | なし | None |
| `close()` | 接続を閉じる | なし | None |

##### _safe_float(val_str)

**目的**: 非数値文字列を安全にfloatに変換

**処理**:
1. 空文字列チェック → 0.0を返す
2. 記号除去(`*`, `-`, 空白)
3. float変換
4. 例外発生時は0.0を返す

##### _safe_int(val_str)

**目的**: 非数値文字列を安全にintに変換

**処理**: `_safe_float`と同様、戻り値はint

##### parse_race_record(data)

**目的**: RAレコード(レース詳細)をパースしてデータベースに保存

**JV-Data構造**:

| フィールド | オフセット | サイズ | 型 | 説明 |
|:---|:---|:---|:---|:---|
| レコード種別 | 0-2 | 2 | ASCII | "RA" |
| レースキー年 | 11-15 | 4 | ASCII | YYYY |
| レースキー月 | 15-17 | 2 | ASCII | MM |
| レースキー日 | 17-19 | 2 | ASCII | DD |
| 場コード | 19-21 | 2 | ASCII | 競馬場コード |
| 回次 | 21-23 | 2 | ASCII | 開催回次 |
| 日次 | 23-25 | 2 | ASCII | 開催日次 |
| レース番号 | 25-27 | 2 | ASCII | レース番号 |
| レース名 | 32-96 | 64 | Shift-JIS | レース名 |
| 発走時刻 | 58-62 | 4 | ASCII | HHMM形式 |

**処理フロー**:
1. レコード種別が"RA"であることを確認
2. レースキー情報を抽出
3. race_idを生成: `{年}{月}{日}{場コード}{レース番号}`
4. レース名をShift-JISでデコード、ヌルバイト除去
5. 発走時刻をHH:MM形式に変換
6. INSERT OR REPLACE でデータベースに保存

##### parse_odds_record(data, rec_type)

**目的**: オッズレコード(O1-O6)をパース

**処理**:
- rec_typeが"O1"で始まる場合、`_parse_tansho_fukusho_odds()`を呼び出す
- 他のオッズタイプは将来拡張可能

##### _parse_tansho_fukusho_odds(data)

**目的**: O1レコード(単勝・複勝オッズ)をパースしてデータベースに保存

**JV-Data構造**:

| フィールド | オフセット | サイズ | 型 | 説明 |
|:---|:---|:---|:---|:---|
| レコード種別 | 0-2 | 2 | ASCII | "O1" |
| レースキー | 11-27 | 16 | ASCII | RAレコードと同様 |
| 発表月 | 27-29 | 2 | ASCII | MM |
| 発表日 | 29-31 | 2 | ASCII | DD |
| 発表時 | 31-33 | 2 | ASCII | HH |
| 発表分 | 33-35 | 2 | ASCII | MM |
| 馬番ごとデータ | 43~ | 8×28 | ASCII | 繰り返し |

**馬番ごとデータ構造** (1頭あたり8バイト):

| フィールド | サイズ | 型 | 説明 |
|:---|:---|:---|:---|
| 馬番 | 2 | ASCII | 01-28 |
| 単勝オッズ | 4 | ASCII | 10倍値 (例: "0120" → 12.0倍) |
| 人気順 | 2 | ASCII | 01-28 |

**処理フロー**:
1. レースキー情報を抽出してrace_idを生成
2. 発表時刻を抽出して`YYYY-MM-DD HH:MM`形式に変換
3. オフセット43から馬番ごとデータを読み込み
4. 最大28頭分ループ:
   - 馬番が0または空の場合は終了
   - 単勝オッズを10で割る
   - 人気順を取得
   - 複勝オッズは0.0(O1レコードには含まれないため)
   - INSERT でデータベースに保存

---

## 5. collector.py 設計

### 5.1 概要

JV-Link APIを使用して過去の時系列オッズデータを取得するメインモジュール。

### 5.2 定数

```python
DB_PATH = 'data/odds_history.db'
```

### 5.3 クラス: JVLinkCollector

#### 5.3.1 コンストラクタ

```python
def __init__(self, service_key="UNKNOWN"):
    """
    Args:
        service_key: JRA-VANのサービスキー
    """
    self.service_key = service_key
    self.jvlink = None
    self.parser = None
```

#### 5.3.2 メソッド一覧

| メソッド名 | 説明 |
|:---|:---|
| `connect()` | JV-Linkへの接続とDB接続 |
| `fetch_historical_odds(start_date, end_date, data_spec)` | 過去オッズデータ取得 |
| `_read_jvdata()` | JVGetsを使用したデータ読み込みループ |
| `close()` | 接続を閉じる |

#### 5.3.3 connect()

**目的**: JV-Linkへの接続とデータベース接続を確立

**処理フロー**:
1. JVLinkオブジェクトを作成: `win32com.client.Dispatch("JVDTLab.JVLink")`
2. JVInit()を実行してサービスキーを登録
3. 戻り値チェック:
   - 0: 成功
   - -1: サービスキー未設定
   - その他: エラー
4. JVDataParserインスタンスを作成

**戻り値**: bool (成功時True)

#### 5.3.4 fetch_historical_odds(start_date, end_date, data_spec="RACE")

**目的**: 指定期間の過去オッズデータを取得

**引数**:
- start_date: 開始日 (YYYYMMDD形式)
- end_date: 終了日 (YYYYMMDD形式)
- data_spec: データ種別 ("RACE" または "0B41")

**処理フロー**:

##### 第1段階: レーススキャン

1. `completed_races.log` を読み込み、完了済みレースのセットを作成
2. `last_attempt.txt` が存在する場合、前回クラッシュしたレースを特定してスキップリストに追加
3. JVOpen("RACE", start_date, end_date)を実行
4. JVGetsでレース情報を取得し、レースキーリストを作成
5. JVClose()でセッションを閉じる

##### 第2段階: 詳細データ取得

1. レースキーリストをループ:
   - 完了済みレースの場合、30日以内ならスキップ、30日以上前なら再取得
   - `mark_attempt_start(race_key)` で処理開始を記録
   - `process_race_with_retry(race_key, max_retries=3)` でリトライ付き取得
   - 成功した場合、`mark_race_complete(race_key)` で完了を記録
   - 0.6秒待機(ドライバ安定性確保)

##### 内部関数: mark_race_complete(race_key)

**目的**: レース完了を記録

**処理**:
1. `completed_races.log` に `race_key,YYYY-MM-DD` を追記
2. `last_attempt.txt` を削除

##### 内部関数: mark_attempt_start(race_key)

**目的**: 処理開始を記録(クラッシュ検知用)

**処理**:
1. `last_attempt.txt` に race_key を書き込み

##### 内部関数: process_race_with_retry(race_key, max_retries=3)

**目的**: 指定したレースをリトライ付きで処理

**処理フロー**:
1. リトライループ(最大3回):
   - JVRTOpen("0B41", race_key)を実行
   - 戻り値チェック:
     - -1, -111, -203: 即座にFalseを返す(データなし)
     - 0以外: エラー、リトライへ
     - 0: 成功、`_read_jvdata()`を呼び出す
   - `_read_jvdata()`が成功した場合、Trueを返す
   - 失敗した場合、ハードリセット:
     - JVClose()
     - `self.jvlink = None`
     - `gc.collect()`
     - 2秒待機
     - `self.connect()` で再接続
2. 3回失敗した場合、Falseを返す

**戻り値**: bool (成功時True)

#### 5.3.5 _read_jvdata()

**目的**: JVGetsを使用してデータを読み込み、パーサーで解析

**処理フロー**:
1. バッファサイズ40,000 Byteのbytearray作成
2. JVGetsループ:
   - JVGets(buff, buff_size)を実行
   - 戻り値チェック:
     - 0: データなし、ループ終了
     - -1: ファイル切り替え、継続
     - 正の値: データ取得成功、解析処理へ
     - 負の値(その他): エラー、Falseを返す
   - レコードタイプ判定(先頭2文字)
   - RAレコードの場合、`parser.parse_race_record()`
   - O1レコードの場合、`parser.parse_odds_record()`
   - 500レコードごとにコミット
3. 最終コミット
4. JVClose()
5. Trueを返す

**戻り値**: bool (成功時True)

---

**続きは Part 2 に記載**

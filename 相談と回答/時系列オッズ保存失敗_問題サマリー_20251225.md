# 時系列オッズ保存失敗（ログ正常終了だがDB未反映） - 問題サマリー[OK]

### 【最新の追記】 2025-02-15 データの取得開始時にも同様の沈黙を確認
2月15日の1レース目開始直後、`JVGets` の最初の呼び出し（Loop 1）で何も言わずにプログラムが終了しました。
- `JV-Link接続成功`、`データベース接続成功` まではログが出ている。
- `[DEBUG] JVGets 実行中... (Loop: 1)` の直後にバッチファイルの待機状態（Press any key...）へ転落。
- 直前まで（2月10日分など）は正常に取得できていたため、日またぎや初期化直後の通信に問題がある可能性。

## 現在の状況

**プロジェクト**: 時系列オッズ取得アプリ (Python, JV-Link)
**環境**: 
- OS: Windows
- Python: 3.12.x (32bit)
- JV-Link: v4.9.0.1 (COMコンポーネント)
- DB: SQLite3

**発生している問題**:
ログ上では「2025-01-26」のデータ取得およびパースが正常終了（[OK]）と出ているが、実際に `data/odds_history.db` を確認すると、当該日付のレコードが1件も保存されていない。

```text
[14/36] Race 202501260702 取得中...
[DEBUG] _read_jvdata 開始 (Thread ID: 0x2e1de88)
[DEBUG] 読み込みループ開始 (BufferSize: 32768)
ファイル切り替え : 0B41000000000000202501260702.jvd
[DEBUG] _read_jvdata 終了処理中 (Records: 115)
[DEBUG] _read_jvdata 正常終了 (Total: 115 records)
[OK]
```
※上記のようにログは出るが、DBへの `INSERT` が行われていないように見える。

## 何をしたいか

1. ログで「正常終了」と出ているデータ（2025-01-26分など）を確実にデータベースへ保存したい。
2. なぜログ上は成功しているのにDBに反映されないのか、その原因を特定し解決したい。

## エラーの詳細

### 症状の詳細
- エラーメッセージや例外は一切発生せず、プログラムは「 Press any key to continue...」で正常終了（または次の待ち状態）になる。
- SQLを直接実行（`SELECT DISTINCT race_id FROM odds_history WHERE race_id LIKE '20250126%'`）しても結果は0件。
- 1月13日分までは正常に保存されている。

### 問題の性質
- サイレントな失敗（実行時エラーはないが、期待した出力がない）。
- JV-Link API (`JVGets`) の呼び出し自体は成功し、データも取得できている（Records数がカウントされている）。

## 試したこと（すべて解決に至らず）

1. **メモリ断片化対策**: 32bit環境のため、バッファサイズを100KB→64KB→1MB→32KBと調整。現在は32KBで安定動作中。
2. **接続管理の徹底**: 毎レース、JVLinkドライバを一度 `JVClose` し、インスタンスを再生成してから接続する「フレッシュスタート戦略」を導入。
3. **DB最適化**: `PRAGMA journal_mode=WAL` を設定し、並列アクセスによるロックを防止。
4. **ガベージコレクション**: 毎レース、`gc.collect()` を実行してメモリリークを抑止。
5. **進捗確認ツールの修正**: `races` テーブルではなく `odds_history` テーブルから直接集計するようにしたが、やはり26日分は0件のまま。

## 関連ファイル

### Pythonスクリプト
- `src/collector.py` - JV-Linkとの通信、メインの取得ループ。
- `src/parser.py` - `JVDataParser`クラス。レコードの分解とSQL実行を担当。

### データベース
- `data/odds_history.db` - 保存先。`races`テーブルと `odds_history`テーブルを持つ。

## 関連コードスニペット

#### `src/parser.py` の保存部分
```python
self.cursor.execute('''
    INSERT INTO odds_history 
    (race_id, time_stamp, umaban, odds_tan, odds_fuku_min, odds_fuku_max, popularity)
    VALUES (?, ?, ?, ?, ?, ?, ?)
    ON CONFLICT(race_id, time_stamp, umaban) DO UPDATE SET
    odds_tan = excluded.odds_tan,
    odds_fuku_min = excluded.odds_fuku_min,
    odds_fuku_max = excluded.odds_fuku_max
''', (race_id, timestamp, umaban, tansho_odds, fuku_min, fuku_max, popularity))
```

## 技術スタック
- **ライブラリ**: `pywin32` (win32com.client)
- **データベース**: `sqlite3`

## 質問したいこと

1. **「ログでは正常終了しているがDBに書かれない」原因として何が考えられるか？**
   - トランザクションがコミットされていない可能性（`self.conn.commit()` は呼んでいるはずだが）。
   - `race_id` や `timestamp` の生成ロジックが26日データで予期せぬ挙動をしている可能性。
2. **サイレントに停止・終了してしまう挙動を止める、または原因を吐かせるにはどうすればよいか？**
3. **JV-Link特有のレコード構造（0B41）において、26日のデータだけがスキップされるような仕様はあるか？**

## 追加情報
- 1月のレースデータ（RA）は取得せず、時系列オッズ（0B41）のみを読み取って `odds_history` に直接突っ込んでいる。
